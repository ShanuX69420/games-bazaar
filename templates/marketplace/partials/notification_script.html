<script>
    {% if user.is_authenticated %}
    {{ request.user.username|json_script:"current-user-username" }}
    function updateBadge(selector, count) {
        const link = document.querySelector(selector);
        if (!link) return;
        let badge = link.querySelector('.badge');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge bg-danger ms-1';
            link.appendChild(badge);
        }
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = '';
        } else {
            if (badge) {
                badge.remove();
            }
        }
    }
    function connectNotifications() {
        const currentUserUsername = JSON.parse(document.getElementById('current-user-username').textContent);
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const notificationSocket = new WebSocket(protocol + window.location.host + '/ws/notifications/');
        notificationSocket.onmessage = function(e) {
    const content = JSON.parse(e.data);
    const type = content.type;
    const data = content.data || {};

    if (type === 'new_message') {
        // Update unread conversations badge
        updateBadge('a[href="{% url 'my_messages' %}"]', data.unread_conversations_count);
        // Play sound only if message is from other user and page is not visible
        if (document.hidden && data.sender_username !== currentUserUsername) {
            playNotificationSound();
        }
    } else if (type === 'read_receipt_update') {
        // Live update badge when messages are marked as read
        updateBadge('a[href="{% url 'my_messages' %}"]', data.unread_conversations_count);
    } else if (type === 'order_update') {
        // Update purchases/sales counters (correct selectors)
        updateBadge('a[href="{% url 'my_sales' %}"]', data.active_sales_count);
        updateBadge('a[href="{% url 'my_purchases' %}"]', data.active_purchases_count);
        if (document.hidden) {
            playNotificationSound();
        }
    }
};
        notificationSocket.onclose = function(e) {
            setTimeout(connectNotifications, 1000);
        };
    }
    connectNotifications();
    {% endif %}
</script>
