{% load time_filters humanize %}
<div class="review-card" id="review-{{ review.pk }}">
    <div class="review-avatar">
        <img src="{{ review.buyer.profile.image_url }}" alt="{{ review.buyer.username }}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
    </div>
    <div class="review-content">
        <div class="review-main-header">
            <div style="flex-grow: 1;">
                <div class="review-user-and-meta">
                    <span class="username">{{ review.created_at|simple_time_since|capfirst }}</span> 
                </div>
                <div class="review-product-info">
                    {% if review.order.product %}
                        {{ review.order.product.game.title }}
                    {% else %}
                        {{ review.order.game_snapshot.title }}
                    {% endif %}, Rs {{ review.order.total_price|floatformat:0|intcomma }}
                </div>
            </div>
            <div class="review-rating">
                <div class="review-stars">
                    {% include 'marketplace/partials/_star_rating.html' with rating=review.rating css_class="review-stars" %}
                </div>
            </div>
        </div>

        <p class="review-comment mb-2">
            {{ review.comment|linebreaksbr }}
        </p>

        {# Show existing reply if it exists #}
        {% if review.reply %}
            {% include 'marketplace/partials/_review_reply.html' with reply=review.reply %}
        {% endif %}

        {# Only show edit/delete for the buyer's own review #}
        {% if request.user == review.buyer %}
            <div class="mt-3">
                <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editReviewModal" data-review-id="{{ review.pk }}" data-edit-url="{% url 'edit_review' review.pk %}">Edit</a>
                <a href="#" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteReviewModal" data-delete-url="{% url 'delete_review' review.pk %}">Delete</a>
            </div>
        {% endif %}
    </div>
</div>