{% extends "base.html" %}
{% load time_filters %}

{% block content %}
<div class="row">
    <div class="col-md-7">
        <h2 class="mb-1">{{ product.game.title }}</h2>
        <p class="lead text-muted">{{ product.listing_title }}</p>
        <hr>

        {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.listing_title }}" class="img-fluid rounded mb-3">
        {% endif %}

        <p><strong>Seller:</strong> <a href="{% url 'public_profile' product.seller.username %}">{{ product.seller.username }}</a></p>
        <p><strong>Price:</strong> Rs{{ product.price }}</p>
        <p><strong>Category:</strong> {{ product.category.name }}</p>

        <h5 class="mt-4">Description:</h5>
        <p>{{ product.description|linebreaks }}</p>

        <div class="mt-4">
            <button id="buy-now-btn" class="btn btn-success btn-lg" data-url="{% url 'create_order' pk=product.pk %}">Buy Now</button>
        </div>
    </div>

    <div class="col-md-5">
        <h4>Chat with seller</h4>
        {% include 'marketplace/partials/unified_chat_panel.html' %}
    </div>
</div>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

{% if request.user.is_authenticated %}
    {{ product.seller.username|json_script:"other-user-username" }}
    {{ request.user.username|json_script:"current-user-username" }}

    {# Include the "Buy Now" button script #}
    <script>
    const buyNowBtn = document.querySelector('#buy-now-btn');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (buyNowBtn) {
        buyNowBtn.addEventListener('click', function() {
            const url = this.dataset.url;
            buyNowBtn.textContent = 'Processing...';
            buyNowBtn.disabled = true;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.order_url) {
                    window.location.href = data.order_url;
                } else {
                    alert(data.message || 'An error occurred.');
                    buyNowBtn.textContent = 'Buy Now';
                    buyNowBtn.disabled = false;
                }
            });
        });
    }
    </script>
    <script>
document.getElementById('buy-now-btn').addEventListener('click', function() {
    // Disable the button to prevent multiple clicks
    this.disabled = true;
    // Add a spinner icon and change the text
    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

    // Your existing AJAX call would go here.
    // For example:
    fetch("{% url 'create_order' product.pk %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}', // Important for security!
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.href = data.order_url; // Redirect to the order page
        } else {
            // Re-enable the button if something went wrong
            this.disabled = false;
            this.innerHTML = 'Buy Now';
            // You could also show an error message here
        }
    });
});
</script>

    {# Include the unified chat WebSocket script #}
    {% include 'marketplace/partials/unified_chat_script.html' %}
{% endif %}
{% endblock %}